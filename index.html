<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EyeTalk - 시선 의사소통 앱</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Apple SD Gothic Neo', sans-serif;
            background: #1a1a1a;
            user-select: none; /* 텍스트 선택 방지 */
        }

        /* 메인 컨테이너: 좌우 2분할 */
        .container {
            display: flex;
            width: 100vw;
            height: 100vh;
        }

        .btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            border: 5px solid #333;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        .btn:active {
            opacity: 0.8; /* 클릭 시 시각적 효과 */
        }

        #yes-btn { background-color: #2ecc71; color: white; border-right: 2px solid #000; }
        #no-btn { background-color: #e74c3c; color: white; border-left: 2px solid #000; }

        .btn h1 {
            font-size: 15vw; /* 화면 크기에 비례 */
            margin: 0;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* 체류 시간(Dwell Time) 시각화 게이지 */
        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0%;
            height: 20px;
            background: rgba(255, 255, 255, 0.9);
            transition: width 0.1s linear;
        }

        /* 시선 포인터 (빨간점) */
        #gaze-dot {
            position: fixed;
            width: 20px;
            height: 20px;
            background: red;
            border: 2px solid white;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%); /* 중앙 정렬 */
            display: none; 
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* 안내 문구 및 컨트롤 패널 */
        #controls {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            text-align: center;
            width: 90%;
            pointer-events: none; /* 클릭 통과 */
        }
        
        #controls * {
            pointer-events: auto; /* 내부 요소는 클릭 가능 */
        }

        #status {
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.2rem;
            margin-bottom: 10px;
            display: inline-block;
        }

        #reset-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 5px;
        }

        /* 웹게이저 비디오 위치 조정 (왼쪽 상단 작게) */
        #webgazerVideoContainer {
            top: 10px !important;
            left: 10px !important;
            width: 160px !important;
            height: 120px !important;
            border: 2px solid white;
            border-radius: 5px;
            opacity: 0.8;
            z-index: 900;
        }
    </style>
</head>
<body>

    <div id="controls">
        <div id="status">시스템 초기화 중...</div>
        <br>
        <button id="reset-btn" onclick="restart()">재시작</button>
    </div>
    
    <div id="gaze-dot"></div>

    <div class="container">
        <div id="yes-btn" class="btn" onclick="calibrate('yes')">
            <h1>예</h1>
            <div id="yes-progress" class="progress-bar"></div>
        </div>
        <div id="no-btn" class="btn" onclick="calibrate('no')">
            <h1>아니오</h1>
            <div id="no-progress" class="progress-bar"></div>
        </div>
    </div>

    <!-- 
      [중요] WebGazer 경로 패치
      상대 경로로 되어 있는 모델 파일 요청을 절대 경로로 변경하여 오류 방지
    -->
    <script>
        (function() {
            const originalFetch = window.fetch;
            window.fetch = function(input, init) {
                // 문자열 형태의 상대 경로 요청 처리
                if (typeof input === 'string' && input.indexOf('./mediapipe/') === 0) {
                    const newUrl = 'https://webgazer.cs.brown.edu/' + input.substring(2);
                    return originalFetch(newUrl, init);
                }
                return originalFetch(input, init);
            };
        })();
    </script>

    <!-- WebGazer 라이브러리 -->
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    
    <script>
        const DWELL_TIME = 1500; // 1.5초
        let lookStart = null;
        let currentTarget = null;
        let isSelecting = false; // 중복 선택 방지

        window.onload = function() {
            // WebGazer가 로드되었는지 확인 후 실행
            if (typeof webgazer !== 'undefined') {
                initWebGazer();
            } else {
                document.getElementById('status').innerText = "라이브러리 로드 실패. 인터넷 연결을 확인하세요.";
            }
        };

        function initWebGazer() {
            document.getElementById('status').innerText = "카메라 권한을 허용해주세요.";

            // 1. 기존 데이터 삭제 (충돌 방지)
            try {
                webgazer.clearData();
            } catch(e) {
                console.warn("데이터 초기화 중 무시 가능한 오류:", e);
            }

            // 2. WebGazer 설정
            // 오류 방지를 위해 가장 안정적인 'ridge' 회귀 모델과 'TFFacemesh' 트래커를 명시적으로 지정
            webgazer.setRegression('ridge') 
                    .setTracker('TFFacemesh')
                    .saveDataAcrossSessions(false) // 세션 저장 끔 (오류 원인 차단)
                    .setGazeListener(function(data, elapsedTime) {
                        if (data == null) return;

                        // 시선 도트 위치 표시
                        const dot = document.getElementById('gaze-dot');
                        dot.style.display = 'block';
                        dot.style.left = data.x + 'px';
                        dot.style.top = data.y + 'px';

                        if (!isSelecting) {
                            checkGaze(data.x, data.y);
                        }
                    })
                    .begin()
                    .then(() => {
                        console.log("WebGazer started successfully");
                        document.getElementById('status').innerText = "빨간 점이 보이나요? '예'와 '아니오'를 각각 5번씩 클릭하여 눈을 학습시켜주세요!";
                        
                        // 비디오 미리보기 및 보정 설정
                        webgazer.showVideoPreview(true) 
                            .showPredictionPoints(false) 
                            .applyKalmanFilter(true); 

                        // 비디오 위치 강제 고정
                        setTimeout(() => {
                            const videoContainer = document.getElementById('webgazerVideoContainer');
                            if(videoContainer) {
                                videoContainer.style.position = 'fixed';
                                videoContainer.style.top = '10px';
                                videoContainer.style.left = '10px';
                                videoContainer.style.zIndex = '900';
                            }
                        }, 1000);
                    })
                    .catch(e => {
                        console.error("WebGazer Init Error:", e);
                        document.getElementById('status').innerText = "실행 오류. (https 환경인지 확인해주세요)";
                        alert("오류 내용: " + e.message + "\n\n(참고: 이 앱은 보안상 HTTPS 또는 localhost 환경에서만 카메라가 작동합니다.)");
                    });
        }

        // 보정 함수
        function calibrate(target) {
            const msg = target === 'yes' ? "예" : "아니오";
            document.getElementById('status').innerText = `${msg} 위치 학습 중... (여러 번 클릭하세요)`;
            
            const btn = document.getElementById(target + '-btn');
            btn.style.opacity = '0.5';
            setTimeout(() => btn.style.opacity = '1', 200);
        }

        function checkGaze(x, y) {
            const yesBtn = document.getElementById('yes-btn').getBoundingClientRect();
            const noBtn = document.getElementById('no-btn').getBoundingClientRect();

            let target = null;

            if (x >= yesBtn.left && x <= yesBtn.right && y >= yesBtn.top && y <= yesBtn.bottom) {
                target = 'yes';
            } else if (x >= noBtn.left && x <= noBtn.right && y >= noBtn.top && y <= noBtn.bottom) {
                target = 'no';
            }

            if (target) {
                if (currentTarget !== target) {
                    currentTarget = target;
                    lookStart = Date.now();
                    updateProgress('yes', 0);
                    updateProgress('no', 0);
                } else {
                    const elapsed = Date.now() - lookStart;
                    const progress = Math.min((elapsed / DWELL_TIME) * 100, 100);
                    updateProgress(target, progress);

                    if (elapsed >= DWELL_TIME) {
                        selectOption(target);
                    }
                }
            } else {
                currentTarget = null;
                lookStart = null;
                updateProgress('yes', 0);
                updateProgress('no', 0);
            }
        }

        function updateProgress(target, percent) {
            const el = document.getElementById(`${target}-progress`);
            if(el) el.style.width = percent + '%';
        }

        function selectOption(choice) {
            isSelecting = true;
            updateProgress(choice, 100);
            
            const message = choice === 'yes' ? "네" : "아니오";
            document.getElementById('status').innerText = `선택됨: ${message}`;
            
            speak(message);

            setTimeout(() => {
                isSelecting = false;
                currentTarget = null;
                lookStart = null;
                updateProgress('yes', 0);
                updateProgress('no', 0);
                document.getElementById('status').innerText = "시선을 움직여 선택하세요.";
            }, 2000);
        }

        function speak(text) {
            if (window.speechSynthesis) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ko-KR';
                window.speechSynthesis.speak(utterance);
            }
        }

        function restart() {
            try {
                if(window.webgazer) webgazer.clearData();
            } catch(e) {}
            location.reload();
        }
    </script>
</body>
</html>
