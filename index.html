<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MediaPipe í—¤ë“œ íŠ¸ë˜í‚¹ (ì•ˆì •ì ì¸ ë²„ì „)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ (ì•ˆì •ì ì¸ CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
            user-select: none;
            touch-action: none; /* ëª¨ë°”ì¼ í„°ì¹˜ ì œìŠ¤ì²˜ ë°©ì§€ */
        }

        /* ì»¤ì„œ (ì‹œì„ ) */
        #cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: rgba(255, 60, 60, 0.8);
            border: 3px solid white;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 9999;
            transition: width 0.2s, height 0.2s, background-color 0.2s;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.4);
        }

        /* í´ë¦­ ìƒíƒœ (ì… ë²Œë¦¼) */
        #cursor.clicking {
            background-color: rgba(34, 197, 94, 0.9); /* Green */
            width: 30px;
            height: 30px;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.6);
        }

        /* ì›¹ìº  ë¯¸ë¦¬ë³´ê¸° (ê±°ìš¸ ëª¨ë“œ) - ë°˜ì‘í˜• í¬ê¸° ì¡°ì ˆ */
        #video-container {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 100px; /* ëª¨ë°”ì¼ ê¸°ë³¸ í¬ê¸° */
            height: 75px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 100;
            background-color: #000;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        /* íƒœë¸”ë¦¿/ë°ìŠ¤í¬íƒ‘ ì´ìƒì—ì„œ í¬ê¸° ì¦ê°€ */
        @media (min-width: 768px) {
            #video-container {
                width: 120px;
                height: 90px;
            }
        }
        
        #video-container:hover {
            opacity: 1;
        }
        
        .input_video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* ì¢Œìš° ë°˜ì „ */
        }

        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        #loading {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        /* ìŠ¬ë¼ì´ë” ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
        input[type=range] {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            outline: none;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen w-screen relative">

    <!-- ì»¤ì„œ ìš”ì†Œ -->
    <div id="cursor"></div>

    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loading">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <h2 class="text-xl font-bold text-gray-800">MediaPipe ëª¨ë¸ ë¡œë”© ì¤‘...</h2>
        <p class="text-gray-500 mt-2">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
    </div>

    <!-- ì›¹ìº  ì»¨í…Œì´ë„ˆ -->
    <div id="video-container">
        <video class="input_video" playsinline></video>
        <div class="absolute bottom-0 left-0 right-0 text-center text-white text-[10px] font-bold bg-black/50 py-0.5">
            Preview
        </div>
    </div>

    <!-- í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë°” - ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ ì ìš© -->
    <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur shadow-[0_-4px_20px_rgba(0,0,0,0.1)] z-50 px-4 md:px-6 py-3 md:py-4 flex flex-col md:flex-row items-center md:justify-between border-t border-gray-200 transition-transform duration-300 gap-3 md:gap-0 max-h-[40vh] overflow-y-auto">
        
        <!-- ì™¼ìª½: íƒ€ì´í‹€ ë° ì„¤ëª… -->
        <div class="flex items-center justify-between w-full md:w-auto space-x-4 min-w-[200px]">
            <div>
                <h1 class="text-base md:text-lg font-bold text-gray-800 leading-tight">í—¤ë“œ íŠ¸ë˜í‚¹</h1>
                <p class="text-[10px] md:text-xs text-gray-500 flex items-center">
                    <span class="w-2 h-2 rounded-full bg-blue-500 inline-block mr-1"></span> ê³ ê°œ ì´ë™
                    <span class="w-2 h-2 rounded-full bg-green-500 inline-block ml-2 mr-1"></span> ì… ë²Œë ¤ í´ë¦­
                </p>
            </div>
            <!-- ëª¨ë°”ì¼ì—ì„œ ì¬ì„¤ì • ë²„íŠ¼ì„ ìƒë‹¨ì— ë°°ì¹˜ -->
            <button onclick="recenter()" class="md:hidden px-3 py-1.5 bg-gray-800 text-white rounded-lg text-xs font-semibold whitespace-nowrap">
                ğŸ¯ ì¬ì„¤ì •
            </button>
        </div>

        <!-- ì¤‘ì•™: ìŠ¬ë¼ì´ë” ì»¨íŠ¸ë¡¤ (ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ëª¨ë°”ì¼ ëŒ€ì‘) -->
        <div class="grid grid-cols-3 md:flex md:flex-1 items-center justify-center gap-2 md:space-x-8 md:mx-4 w-full md:w-auto">
            <!-- ìˆ˜í‰ ê°ë„ -->
            <div class="flex flex-col w-full md:w-32">
                 <label class="text-[10px] md:text-[11px] font-semibold text-gray-600 flex justify-between mb-1">
                     ìˆ˜í‰(X) <span id="val-x" class="text-blue-600">2.5</span>
                 </label>
                 <input type="range" min="1" max="5" step="0.1" value="2.5" class="w-full accent-blue-600 cursor-pointer" oninput="updateSen(this, 'x')">
            </div>
            <!-- ìˆ˜ì§ ê°ë„ -->
            <div class="flex flex-col w-full md:w-32">
                 <label class="text-[10px] md:text-[11px] font-semibold text-gray-600 flex justify-between mb-1">
                     ìˆ˜ì§(Y) <span id="val-y" class="text-blue-600">2.5</span>
                 </label>
                 <input type="range" min="1" max="5" step="0.1" value="2.5" class="w-full accent-blue-600 cursor-pointer" oninput="updateSen(this, 'y')">
            </div>
            <!-- ë°˜ì‘ ì†ë„ -->
            <div class="flex flex-col w-full md:w-32">
                 <label class="text-[10px] md:text-[11px] font-semibold text-gray-600 flex justify-between mb-1">
                     ì†ë„ <span id="val-s" class="text-blue-600">0.12</span>
                 </label>
                 <input type="range" min="0.01" max="0.3" step="0.01" value="0.12" class="w-full accent-gray-600 cursor-pointer" oninput="updateSmooth(this)">
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì¬ì„¤ì • ë²„íŠ¼ (ë°ìŠ¤í¬íƒ‘ìš©) -->
        <div class="hidden md:flex min-w-[120px] justify-end">
            <button onclick="recenter()" class="px-5 py-2.5 bg-gray-800 hover:bg-gray-900 text-white rounded-lg text-sm font-semibold transition shadow-md hover:shadow-lg transform active:scale-95 whitespace-nowrap">
                ğŸ¯ ì¤‘ì‹¬ì  ì¬ì„¤ì •
            </button>
        </div>
    </div>

    <!-- ë„¤/ì•„ë‹ˆì˜¤ ëŒ€í˜• ë²„íŠ¼ ì˜ì—­ - ë°˜ì‘í˜• ë°°ì¹˜ (flex-col md:flex-row) -->
    <!-- ëª¨ë°”ì¼ì—ì„œëŠ” ìœ„ì•„ë˜(col), ë°ìŠ¤í¬íƒ‘ì—ì„œëŠ” ì¢Œìš°(row) -->
    <!-- íŒ¨ë”©ì„ í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë°” ë†’ì´ì— ë§ì¶° ë„‰ë„‰í•˜ê²Œ ì„¤ì • (pb-40 md:pb-24) -->
    <div class="absolute inset-0 flex flex-col md:flex-row items-center justify-center pointer-events-none pb-32 md:pb-24 px-4 md:px-8 gap-4 md:gap-8 pt-4 md:pt-0"> 
        
        <!-- ë„¤ (ëª¨ë°”ì¼: ìœ„ / ë°ìŠ¤í¬íƒ‘: ì™¼ìª½) -->
        <button onclick="speakAndFlash(this, 'ë„¤')" class="pointer-events-auto w-full md:flex-1 h-full max-h-[35vh] md:max-h-80 md:max-w-lg rounded-3xl bg-green-500 hover:bg-green-600 text-white text-6xl md:text-8xl font-black shadow-xl md:shadow-2xl transform transition active:scale-95 border-b-4 md:border-b-8 border-green-700 active:border-b-0 active:translate-y-2 flex items-center justify-center group">
            <span class="group-hover:animate-pulse">â­• ë„¤</span>
        </button>

        <!-- ì•„ë‹ˆì˜¤ (ëª¨ë°”ì¼: ì•„ë˜ / ë°ìŠ¤í¬íƒ‘: ì˜¤ë¥¸ìª½) -->
        <button onclick="speakAndFlash(this, 'ì•„ë‹ˆì˜¤')" class="pointer-events-auto w-full md:flex-1 h-full max-h-[35vh] md:max-h-80 md:max-w-lg rounded-3xl bg-red-500 hover:bg-red-600 text-white text-6xl md:text-8xl font-black shadow-xl md:shadow-2xl transform transition active:scale-95 border-b-4 md:border-b-8 border-red-700 active:border-b-0 active:translate-y-2 flex items-center justify-center group">
            <span class="group-hover:animate-pulse">âŒ ì•„ë‹ˆì˜¤</span>
        </button>

    </div>

    <script>
        const videoElement = document.getElementsByClassName('input_video')[0];
        const cursor = document.getElementById('cursor');
        const loadingScreen = document.getElementById('loading');
        
        // ìƒíƒœ ë³€ìˆ˜
        let sensitivityX = 2.5;
        let sensitivityY = 2.5;
        let smoothing = 0.12; // 0 ~ 1 (ë‚®ì„ìˆ˜ë¡ ë¶€ë“œëŸ¬ì›€)
        
        // ì¢Œí‘œ ë³€ìˆ˜ (LERPìš©)
        let targetX = window.innerWidth / 2;
        let targetY = window.innerHeight / 2;
        let currentX = window.innerWidth / 2;
        let currentY = window.innerHeight / 2;

        // ì¤‘ì‹¬ì  ë³´ì •ìš©
        let noseOffsetX = 0;
        let noseOffsetY = 0;
        let isCalibrated = false;

        // MediaPipe FaceMesh ì´ˆê¸°í™”
        const faceMesh = new FaceMesh({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
        }});

        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true, // ëˆˆ, ì…ìˆ  ì •ë°€ ì¶”ì 
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        faceMesh.onResults(onResults);

        // ì¹´ë©”ë¼ ì„¤ì •
        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await faceMesh.send({image: videoElement});
            },
            width: 640,
            height: 480
        });
        
        // ì¹´ë©”ë¼ ì‹œì‘
        camera.start()
            .then(() => {
                console.log("ì¹´ë©”ë¼ ì‹œì‘ë¨");
            })
            .catch(err => {
                console.error("ì¹´ë©”ë¼ ì˜¤ë¥˜:", err);
                alert("ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            });

        function onResults(results) {
            // ë¡œë”© í™”ë©´ ì œê±°
            if (loadingScreen.style.display !== 'none') {
                loadingScreen.style.display = 'none';
            }

            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];
                
                // 1. ì½” ë ì¢Œí‘œ (Landmark #4)
                const nose = landmarks[4];
                
                // ì¢Œí‘œ ì •ê·œí™” (ì¤‘ì‹¬ì„ 0,0ìœ¼ë¡œ ë§ì¶¤)
                // xëŠ” ì¢Œìš° ë°˜ì „ì„ ê³ ë ¤í•˜ì—¬ (1 - x) - 0.5
                let nx = (1 - nose.x) - 0.5; 
                let ny = nose.y - 0.5;

                // ìµœì´ˆ 1íšŒ ìë™ ë³´ì •
                if (!isCalibrated) {
                    noseOffsetX = nx;
                    noseOffsetY = ny;
                    isCalibrated = true;
                }

                // ì˜¤í”„ì…‹ ì ìš© (í˜„ì¬ ë¨¸ë¦¬ ìœ„ì¹˜ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ)
                nx -= noseOffsetX;
                ny -= noseOffsetY;

                // 2. í™”ë©´ ì¢Œí‘œë¡œ ë³€í™˜ ë° ê°ë„ ì ìš©
                // í™”ë©´ ì¤‘ì‹¬ì—ì„œ ì‹œì‘
                const screenCX = window.innerWidth / 2;
                const screenCY = window.innerHeight / 2;

                targetX = screenCX + (nx * window.innerWidth * sensitivityX);
                targetY = screenCY + (ny * window.innerHeight * sensitivityY);

                // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šê²Œ í´ë¨í•‘
                targetX = Math.max(0, Math.min(window.innerWidth, targetX));
                targetY = Math.max(0, Math.min(window.innerHeight, targetY));

                // 3. ì… ë²Œë¦¼ ê°ì§€ (í´ë¦­)
                // ìœ—ì…ìˆ (#13)ê³¼ ì•„ë«ì…ìˆ (#14) ì‚¬ì´ì˜ ê±°ë¦¬ ê³„ì‚°
                const upperLip = landmarks[13];
                const lowerLip = landmarks[14];
                const mouthOpenDist = Math.abs(upperLip.y - lowerLip.y);
                
                if (mouthOpenDist > 0.05) { // ì„ê³„ê°’
                    cursor.classList.add('clicking');
                    triggerClick();
                } else {
                    cursor.classList.remove('clicking');
                }
            }
        }

        // ë¶€ë“œëŸ¬ìš´ ì›€ì§ì„ì„ ìœ„í•œ ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„
        function animate() {
            // Linear Interpolation (LERP)
            currentX = currentX + (targetX - currentX) * smoothing;
            currentY = currentY + (targetY - currentY) * smoothing;

            cursor.style.left = `${currentX}px`;
            cursor.style.top = `${currentY}px`;

            requestAnimationFrame(animate);
        }
        animate();

        // í´ë¦­ íŠ¸ë¦¬ê±° (ê°€ìƒì˜ í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ)
        let lastClickTime = 0;
        function triggerClick() {
            const now = Date.now();
            if (now - lastClickTime > 1000) { // ì¿¨ë‹¤ìš´ 1ì´ˆë¡œ ì¦ê°€ (ìŒì„± ì¶œë ¥ ì¤‘ë³µ ë°©ì§€)
                lastClickTime = now;
                
                // í˜„ì¬ ì»¤ì„œ ìœ„ì¹˜ì— ìˆëŠ” ìš”ì†Œ ì°¾ê¸°
                cursor.style.display = 'none';
                const elem = document.elementFromPoint(currentX, currentY);
                cursor.style.display = 'block';

                if (elem) {
                    // ë²„íŠ¼ ë‚´ë¶€ì˜ ìš”ì†Œê°€ ì„ íƒë  ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ê°€ì¥ ê°€ê¹Œìš´ ë²„íŠ¼ ì°¾ê¸°
                    const btn = elem.closest('button');
                    if (btn) {
                        btn.click();
                        
                        // ì‹œê°ì  í”¼ë“œë°±
                        const ripple = document.createElement('div');
                        ripple.style.position = 'fixed';
                        ripple.style.left = currentX + 'px';
                        ripple.style.top = currentY + 'px';
                        ripple.style.transform = 'translate(-50%, -50%)';
                        ripple.style.width = '20px';
                        ripple.style.height = '20px';
                        ripple.style.background = 'rgba(34, 197, 94, 0.5)';
                        ripple.style.borderRadius = '50%';
                        ripple.style.pointerEvents = 'none';
                        ripple.style.zIndex = '9998';
                        ripple.style.transition = 'all 0.5s';
                        document.body.appendChild(ripple);
                        
                        setTimeout(() => {
                            ripple.style.width = '100px';
                            ripple.style.height = '100px';
                            ripple.style.opacity = '0';
                        }, 10);
                        setTimeout(() => ripple.remove(), 500);
                    }
                }
            }
        }

        // UI ì»¨íŠ¸ë¡¤ í•¨ìˆ˜ë“¤
        function updateSen(el, axis) {
            const val = parseFloat(el.value);
            document.getElementById(`val-${axis}`).innerText = val;
            if (axis === 'x') sensitivityX = val;
            if (axis === 'y') sensitivityY = val;
        }

        function updateSmooth(el) {
            const val = parseFloat(el.value);
            document.getElementById('val-s').innerText = val;
            smoothing = val;
        }

        function recenter() {
            isCalibrated = false;
        }

        // ìŒì„± ì¶œë ¥ ë° íš¨ê³¼ í•¨ìˆ˜
        function speakAndFlash(el, text) {
            // TTS ìŒì„± ì¶œë ¥
            if ('speechSynthesis' in window) {
                // ê¸°ì¡´ ìŒì„± ì·¨ì†Œ (ì¤‘ë³µ ì¬ìƒ ë°©ì§€)
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ko-KR'; // í•œêµ­ì–´ ì„¤ì •
                utterance.rate = 1.0; // ì†ë„
                utterance.pitch = 1.0; // í†¤
                
                window.speechSynthesis.speak(utterance);
            }

            // ì‹œê°ì  íš¨ê³¼ (ëˆŒë¦¼)
            // Tailwindì˜ active í´ë˜ìŠ¤ì™€ transitionì´ ì²˜ë¦¬í•˜ì§€ë§Œ JSë¡œë„ í™•ì‹¤í•˜ê²Œ í”¼ë“œë°±
            // el.style.transform = 'scale(0.95)';
            // setTimeout(() => el.style.transform = '', 150);
        }

        // ì°½ í¬ê¸° ë³€ê²½ ëŒ€ì‘
        window.addEventListener('resize', () => {
            currentX = window.innerWidth / 2;
            currentY = window.innerHeight / 2;
        });
    </script>
</body>
</html>
