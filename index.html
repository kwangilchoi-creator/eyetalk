<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EyeTalk - 시선 의사소통 앱</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Apple SD Gothic Neo', sans-serif;
            background: #1a1a1a;
            user-select: none;
        }

        .container {
            display: flex;
            width: 100vw;
            height: 100vh;
        }

        .btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            border: 5px solid #333;
            box-sizing: border-box;
            opacity: 0.3; /* 시작 전엔 흐리게 */
            pointer-events: none; /* 시작 전엔 클릭 불가 */
            transition: opacity 0.5s;
        }

        #yes-btn { background-color: #2ecc71; color: white; border-right: 2px solid #000; }
        #no-btn { background-color: #e74c3c; color: white; border-left: 2px solid #000; }

        .btn h1 {
            font-size: 15vw;
            margin: 0;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0%;
            height: 20px;
            background: rgba(255, 255, 255, 0.9);
            transition: width 0.1s linear;
        }

        #gaze-dot {
            position: fixed;
            width: 20px;
            height: 20px;
            background: red;
            border: 2px solid white;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            display: none; 
        }

        /* 중앙 시작 버튼 및 안내 */
        #start-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
            text-align: center;
        }

        #start-btn {
            background: #e67e22;
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(230, 126, 34, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        #status {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1rem;
            z-index: 1000;
            display: none; /* 시작 후 표시 */
        }

        #reset-btn {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: #3498db;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
            display: none;
        }

        /* 디버그 로그창 (접었다 폈다 가능) */
        #debug-console {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: rgba(0, 0, 0, 0.9);
            color: #0f0;
            font-family: monospace;
            font-size: 11px;
            overflow-y: scroll;
            z-index: 3000;
            padding: 10px;
            box-sizing: border-box;
            border-top: 2px solid #555;
            display: none; /* 문제 해결 시 숨김 가능 */
        }

        #webgazerVideoContainer {
            position: fixed !important;
            top: 10px !important;
            left: 10px !important;
            width: 120px !important; /* 모바일 고려해서 조금 더 작게 */
            height: 90px !important;
            border: 2px solid white;
            opacity: 0.8;
            z-index: 900;
            display: none; /* 시작 전엔 숨김 */
        }
    </style>
</head>
<body>

    <!-- 시작 화면 -->
    <div id="start-screen">
        <h2>EyeTalk</h2>
        <p id="guide-text">
            1. 카메라 권한을 허용해주세요.<br>
            2. 얼굴을 비추고 화면을 응시하세요.<br>
            <br>
            <span style="color: #f1c40f; font-size: 0.9rem;">
                * 카카오톡/문자 브라우저에서는<br>작동하지 않을 수 있습니다.<br>
                Chrome 또는 Safari로 열어주세요.
            </span>
        </p>
        <button id="start-btn" onclick="startApp()">카메라 켜기 & 시작</button>
        <div id="error-msg" style="color: #ff6b6b; margin-top: 20px; font-size: 0.9rem; white-space: pre-line;"></div>
    </div>

    <div id="status">준비 중...</div>
    <button id="reset-btn" onclick="location.reload()">새로고침</button>
    
    <div id="gaze-dot"></div>

    <div class="container">
        <div id="yes-btn" class="btn" onclick="calibrate('yes')">
            <h1>예</h1>
            <div id="yes-progress" class="progress-bar"></div>
        </div>
        <div id="no-btn" class="btn" onclick="calibrate('no')">
            <h1>아니오</h1>
            <div id="no-progress" class="progress-bar"></div>
        </div>
    </div>

    <!-- 로그창 -->
    <div id="debug-console">
        <div>[System] 페이지 로드됨</div>
    </div>

    <!-- 1. WebGazer 경로 패치 -->
    <script>
        (function() {
            const originalFetch = window.fetch;
            window.fetch = function(input, init) {
                if (typeof input === 'string' && input.indexOf('./mediapipe/') === 0) {
                    const newUrl = 'https://webgazer.cs.brown.edu/' + input.substring(2);
                    return originalFetch(newUrl, init);
                }
                return originalFetch(input, init);
            };
        })();
    </script>

    <!-- 2. WebGazer 로드 -->
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    
    <script>
        const DWELL_TIME = 1500;
        let lookStart = null;
        let currentTarget = null;
        let isSelecting = false;
        let isStarted = false;

        // 로그 출력 함수
        function log(msg, isError = false) {
            const consoleDiv = document.getElementById('debug-console');
            // 에러가 발생하면 콘솔창을 강제로 보여줌
            if (isError) consoleDiv.style.display = 'block';
            
            const line = document.createElement('div');
            line.innerText = `> ${msg}`;
            if (isError) line.style.color = '#ff5555';
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(msg);

            // 심각한 에러는 화면 중앙에도 표시
            if (isError) {
                document.getElementById('error-msg').innerText = msg;
            }
        }

        window.onerror = function(msg, url, line) {
            log(`Error: ${msg}`, true);
            return false;
        };

        // 인앱 브라우저 체크
        window.onload = function() {
            const ua = navigator.userAgent.toLowerCase();
            const isInApp = ua.includes('kakao') || ua.includes('line') || ua.includes('inapp') || ua.includes('naver');
            
            if (isInApp) {
                document.getElementById('guide-text').innerHTML = 
                    "<span style='color:red; font-size:1.2rem; font-weight:bold;'>⚠️ 주의: 인앱 브라우저 감지됨</span><br><br>" +
                    "카카오톡/라인 등에서는 카메라가 차단됩니다.<br>" +
                    "우측 상단 메뉴(⋮)를 눌러<br>'다른 브라우저로 열기'를 선택하세요.";
                document.getElementById('start-btn').style.display = 'none';
                log("인앱 브라우저 감지됨. 실행 차단.");
            } else if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                log("HTTPS 아님. 리다이렉트 시도.");
                location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
            }
        };

        async function startApp() {
            if (isStarted) return;
            const startBtn = document.getElementById('start-btn');
            startBtn.innerText = "로딩 중... (30초 소요)";
            startBtn.disabled = true;
            startBtn.style.opacity = 0.5;

            log("시작 버튼 클릭됨. 카메라 권한 요청...");

            try {
                // 1. 카메라 권한 명시적 요청 (User Gesture 필수)
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                log("카메라 권한 획득 성공.");
                stream.getTracks().forEach(track => track.stop()); // 테스트 후 끄기

                // 2. WebGazer 초기화
                await initWebGazer();
                
                // 3. UI 전환
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('status').style.display = 'block';
                document.getElementById('reset-btn').style.display = 'block';
                document.getElementById('webgazerVideoContainer').style.display = 'block';
                
                // 버튼 활성화
                const btns = document.querySelectorAll('.btn');
                btns.forEach(b => {
                    b.style.opacity = 1;
                    b.style.pointerEvents = 'auto';
                });

                isStarted = true;
                log("앱 시작 완료.");

            } catch (err) {
                log(`[실행 실패] ${err.name}: ${err.message}`, true);
                startBtn.innerText = "다시 시도";
                startBtn.disabled = false;
                startBtn.style.opacity = 1;
                
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    alert("카메라 권한이 거부되었습니다.\n브라우저 설정에서 카메라를 허용하고 다시 시도해주세요.");
                } else {
                    alert("오류 발생: " + err.message + "\n\n다른 브라우저(Chrome/Safari)를 사용해보세요.");
                }
            }
        }

        async function initWebGazer() {
            if (typeof webgazer === 'undefined') {
                throw new Error("WebGazer 라이브러리 로드 실패");
            }

            try { webgazer.clearData(); } catch(e) {}

            log("WebGazer 설정 및 학습 모델 로딩...");

            // 가장 기본 설정으로 시도 (안정성 최우선)
            await webgazer.setRegression('ridge') 
                .setTracker('TFFacemesh')
                .saveDataAcrossSessions(false)
                .setGazeListener(gazeListener)
                .begin();

            log("WebGazer.begin() 성공.");

            webgazer.showVideoPreview(true) 
                .showPredictionPoints(false) 
                .applyKalmanFilter(true);
            
            // 비디오 위치 고정
            setTimeout(() => {
                const v = document.getElementById('webgazerVideoContainer');
                if(v) {
                    v.style.position = 'fixed';
                    v.style.top = '10px';
                    v.style.left = '10px';
                    v.style.zIndex = '900';
                }
            }, 1000);

            document.getElementById('status').innerText = "빨간 점을 보며 버튼을 여러 번 누르세요.";
        }

        function gazeListener(data, elapsedTime) {
            if (data == null) return;
            
            const dot = document.getElementById('gaze-dot');
            dot.style.display = 'block';
            dot.style.left = data.x + 'px';
            dot.style.top = data.y + 'px';

            if (!isSelecting && isStarted) {
                checkGaze(data.x, data.y);
            }
        }

        function checkGaze(x, y) {
            const yesBtn = document.getElementById('yes-btn').getBoundingClientRect();
            const noBtn = document.getElementById('no-btn').getBoundingClientRect();
            let target = null;

            if (x >= yesBtn.left && x <= yesBtn.right && y >= yesBtn.top && y <= yesBtn.bottom) target = 'yes';
            else if (x >= noBtn.left && x <= noBtn.right && y >= noBtn.top && y <= noBtn.bottom) target = 'no';

            if (target) {
                if (currentTarget !== target) {
                    currentTarget = target;
                    lookStart = Date.now();
                    updateProgress('yes', 0); updateProgress('no', 0);
                } else {
                    const elapsed = Date.now() - lookStart;
                    const progress = Math.min((elapsed / DWELL_TIME) * 100, 100);
                    updateProgress(target, progress);
                    if (elapsed >= DWELL_TIME) selectOption(target);
                }
            } else {
                currentTarget = null;
                lookStart = null;
                updateProgress('yes', 0); updateProgress('no', 0);
            }
        }

        function updateProgress(target, percent) {
            const el = document.getElementById(`${target}-progress`);
            if(el) el.style.width = percent + '%';
        }

        function selectOption(choice) {
            isSelecting = true;
            updateProgress(choice, 100);
            const message = choice === 'yes' ? "네" : "아니오";
            document.getElementById('status').innerText = `선택됨: ${message}`;
            
            if (window.speechSynthesis) {
                const utterance = new SpeechSynthesisUtterance(message);
                utterance.lang = 'ko-KR';
                window.speechSynthesis.speak(utterance);
            }

            setTimeout(() => {
                isSelecting = false;
                currentTarget = null;
                lookStart = null;
                updateProgress('yes', 0);
                updateProgress('no', 0);
                document.getElementById('status').innerText = "시선을 움직여 선택하세요.";
            }, 2000);
        }

        function calibrate(target) {
            log(`${target} 버튼 클릭됨 (보정)`);
            const btn = document.getElementById(target + '-btn');
            btn.style.opacity = '0.5';
            setTimeout(() => btn.style.opacity = '1', 200);
        }
    </script>
</body>
</html>
