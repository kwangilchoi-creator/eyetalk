<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EyeTalk - ì‹œì„  ì˜ì‚¬ì†Œí†µ ì•±</title>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Apple SD Gothic Neo', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1a1a1a;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        .container {
            display: flex;
            width: 100vw;
            height: 100vh;
        }

        .btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            border: 5px solid #333;
            box-sizing: border-box;
            opacity: 0.3;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .btn.active {
            opacity: 1;
            pointer-events: auto;
        }

        #yes-btn { 
            background-color: #2ecc71; 
            color: white; 
            border-right: 2px solid #000; 
        }
        
        #no-btn { 
            background-color: #e74c3c; 
            color: white; 
            border-left: 2px solid #000; 
        }

        .btn h1 {
            font-size: min(15vw, 120px);
            margin: 0;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: bold;
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0%;
            height: 25px;
            background: rgba(255, 255, 255, 0.9);
            transition: width 0.05s linear;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        #gaze-dot {
            position: fixed;
            width: 24px;
            height: 24px;
            background: radial-gradient(circle, #ff0000 0%, #cc0000 100%);
            border: 3px solid white;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            display: none;
            box-shadow: 0 0 10px rgba(255,0,0,0.8);
        }

        #start-screen {
            position: fixed;
            top: 0; 
            left: 0;
            width: 100%; 
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        #start-screen h2 {
            font-size: 3rem;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        #guide-text {
            font-size: 1.1rem;
            line-height: 1.8;
            max-width: 600px;
            margin-bottom: 20px;
        }

        #start-btn {
            background: linear-gradient(135deg, #e67e22, #d35400);
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
            box-shadow: 0 6px 20px rgba(230, 126, 34, 0.5);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #start-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(230, 126, 34, 0.6);
        }

        #start-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #status {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: #fff;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1.1rem;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        #reset-btn {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1000;
            display: none;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(52, 152, 219, 0.3);
        }

        #error-msg {
            color: #ff6b6b;
            margin-top: 20px;
            font-size: 0.95rem;
            white-space: pre-line;
            max-width: 500px;
        }

        #debug-console {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 150px;
            background: rgba(0, 0, 0, 0.95);
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            overflow-y: auto;
            z-index: 3000;
            padding: 10px;
            box-sizing: border-box;
            border-top: 2px solid #333;
            display: block;
        }

        .debug-line {
            margin: 2px 0;
            padding: 2px 0;
        }

        .debug-error {
            color: #ff5555 !important;
            font-weight: bold;
        }

        #webgazerVideoContainer {
            position: fixed !important;
            top: 10px !important;
            right: 10px !important;
            width: 160px !important;
            height: 120px !important;
            border: 3px solid rgba(255,255,255,0.5);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            z-index: 999 !important;
            display: none;
        }

        #webgazerVideoContainer canvas,
        #webgazerVideoContainer video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
        }

        #webgazerFaceFeedbackBox,
        #webgazerGazeDot {
            display: none !important;
        }

        @media (max-width: 768px) {
            #start-screen h2 {
                font-size: 2rem;
            }
            
            #guide-text {
                font-size: 0.95rem;
            }
            
            #start-btn {
                padding: 15px 35px;
                font-size: 1.2rem;
            }
            
            #webgazerVideoContainer {
                width: 120px !important;
                height: 90px !important;
            }
        }
    </style>
</head>
<body>

    <div id="start-screen">
        <h2>ğŸ‘ï¸ EyeTalk</h2>
        <p id="guide-text">
            1. ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”<br>
            2. ì–¼êµ´ì„ í™”ë©´ì— ì •ë©´ìœ¼ë¡œ ë¹„ì¶”ì„¸ìš”<br>
            3. ì–‘ìª½ ë²„íŠ¼ì„ ë²ˆê°ˆì•„ ì—¬ëŸ¬ ë²ˆ ì‘ì‹œí•˜ì„¸ìš”<br>
            <br>
            <span style="color: #f1c40f; font-size: 0.9rem;">
                âš ï¸ ì¹´ì¹´ì˜¤í†¡/ë¬¸ì ë¸Œë¼ìš°ì €ì—ì„œëŠ”<br>ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
                Chrome ë˜ëŠ” Safarië¡œ ì—´ì–´ì£¼ì„¸ìš”
            </span>
        </p>
        <button id="start-btn" onclick="startApp()">ğŸ¥ ì¹´ë©”ë¼ ì¼œê³  ì‹œì‘í•˜ê¸°</button>
        <div id="error-msg"></div>
    </div>

    <div id="status">ì¤€ë¹„ ì¤‘...</div>
    <button id="reset-btn" onclick="resetApp()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    
    <div id="gaze-dot"></div>

    <div class="container">
        <div id="yes-btn" class="btn" onclick="handleClick('yes')">
            <h1>ì˜ˆ</h1>
            <div id="yes-progress" class="progress-bar"></div>
        </div>
        <div id="no-btn" class="btn" onclick="handleClick('no')">
            <h1>ì•„ë‹ˆì˜¤</h1>
            <div id="no-progress" class="progress-bar"></div>
        </div>
    </div>

    <div id="debug-console"></div>

    <script>
        // MediaPipe ê²½ë¡œ ìˆ˜ì • - ë” ê°•ë ¥í•œ ë²„ì „
        (function() {
            const originalFetch = window.fetch;
            window.fetch = function(input, init) {
                if (typeof input === 'string') {
                    // mediapipe ê´€ë ¨ ëª¨ë“  ê²½ë¡œ ìˆ˜ì •
                    if (input.includes('mediapipe/') || input.includes('node_modules')) {
                        const fileName = input.split('/').pop();
                        const newUrl = `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${fileName}`;
                        console.log(`[Fetch Redirect] ${input} -> ${newUrl}`);
                        return originalFetch(newUrl, init);
                    }
                }
                return originalFetch(input, init);
            };

            // XMLHttpRequestë„ íŒ¨ì¹˜
            const originalOpen = XMLHttpRequest.prototype.open;
            XMLHttpRequest.prototype.open = function(method, url, ...args) {
                if (typeof url === 'string' && (url.includes('mediapipe/') || url.includes('node_modules'))) {
                    const fileName = url.split('/').pop();
                    url = `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${fileName}`;
                    console.log(`[XHR Redirect] -> ${url}`);
                }
                return originalOpen.call(this, method, url, ...args);
            };
        })();

        // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬ ê°•í™”
        window.addEventListener('error', function(event) {
            console.error('[Global Error]', event.error);
            log(`ì „ì—­ ì—ëŸ¬: ${event.error?.message || event.message}`, true);
            event.preventDefault();
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('[Unhandled Promise]', event.reason);
            log(`Promise ì—ëŸ¬: ${event.reason?.message || event.reason}`, true);
            event.preventDefault();
        });
    </script>

    <script src="https://webgazer.cs.brown.edu/webgazer.js" 
            onerror="handleWebGazerLoadError()"
            onload="handleWebGazerLoaded()"></script>
    
    <script>
        const DWELL_TIME = 1800;
        const SMOOTHING_FACTOR = 0.3;
        
        let lookStart = null;
        let currentTarget = null;
        let isSelecting = false;
        let isStarted = false;
        let smoothX = 0;
        let smoothY = 0;
        let calibrationCount = 0;
        let webgazerReady = false;
        let webgazerLoaded = false;
        let gazeDataCount = 0;

        function handleWebGazerLoaded() {
            webgazerLoaded = true;
            log("âœ“ WebGazer ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ");
        }

        function handleWebGazerLoadError() {
            log("âœ— WebGazer ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨", true);
            document.getElementById('error-msg').textContent = 
                "WebGazer ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨\nì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”";
        }

        function log(msg, isError = false) {
            const consoleDiv = document.getElementById('debug-console');
            if (!consoleDiv) return;
            
            const line = document.createElement('div');
            line.className = 'debug-line' + (isError ? ' debug-error' : '');
            const timestamp = new Date().toLocaleTimeString('ko-KR', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            line.textContent = `[${timestamp}] ${msg}`;
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            
            if (isError) {
                console.error(msg);
                const errorMsg = document.getElementById('error-msg');
                if (errorMsg) errorMsg.textContent = msg;
            } else {
                console.log(msg);
            }
            
            if (consoleDiv.children.length > 100) {
                consoleDiv.removeChild(consoleDiv.firstChild);
            }
        }

        window.onerror = function(msg, url, line, col, error) {
            log(`Error: ${msg} at ${line}:${col}`, true);
            return false;
        };

        window.onload = function() {
            log("í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ");
            
            const ua = navigator.userAgent.toLowerCase();
            const isInApp = ua.includes('kakao') || ua.includes('line') || 
                           ua.includes('inapp') || ua.includes('naver') ||
                           ua.includes('fban') || ua.includes('fbav');
            
            if (isInApp) {
                document.getElementById('guide-text').innerHTML = 
                    "<span style='color:#ff6b6b; font-size:1.3rem; font-weight:bold;'>âš ï¸ ì¸ì•± ë¸Œë¼ìš°ì € ê°ì§€ë¨</span><br><br>" +
                    "ì¹´ì¹´ì˜¤í†¡/ë¼ì¸ ë“±ì—ì„œëŠ” ì¹´ë©”ë¼ê°€ ì°¨ë‹¨ë©ë‹ˆë‹¤<br><br>" +
                    "ìš°ì¸¡ ìƒë‹¨ ë©”ë‰´(<strong>â‹®</strong> ë˜ëŠ” <strong>Â·Â·Â·</strong>)ë¥¼ ëˆŒëŸ¬<br>" +
                    "<strong>'ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¡œ ì—´ê¸°'</strong> ë˜ëŠ”<br>" +
                    "<strong>'Safarië¡œ ì—´ê¸°'</strong>ë¥¼ ì„ íƒí•˜ì„¸ìš”";
                document.getElementById('start-btn').style.display = 'none';
                log("ì¸ì•± ë¸Œë¼ìš°ì € ê°ì§€ - ì‹¤í–‰ ì°¨ë‹¨", true);
                return;
            }
            
            if (location.protocol !== 'https:' && 
                location.hostname !== 'localhost' && 
                location.hostname !== '127.0.0.1') {
                log("HTTPì—ì„œ HTTPSë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸");
                location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
                return;
            }
        };

        function clearLocalData() {
            return new Promise((resolve) => {
                log("ê¸°ì¡´ í•™ìŠµ ë°ì´í„° ì‚­ì œ ì‹œì‘");
                
                try {
                    // LocalStorage í´ë¦¬ì–´
                    localStorage.clear();
                    sessionStorage.clear();
                    
                    // WebGazer ë°ì´í„° í´ë¦¬ì–´
                    if (window.webgazer && typeof webgazer.clearData === 'function') {
                        try {
                            webgazer.clearData();
                            log("WebGazer ë©”ëª¨ë¦¬ ë°ì´í„° ì‚­ì œ");
                        } catch (e) {
                            log("WebGazer clearData ì˜¤ë¥˜ (ë¬´ì‹œ): " + e.message);
                        }
                    }
                    
                    // IndexedDB ì‚­ì œ
                    const dbDeleteRequest = indexedDB.deleteDatabase('webgazer');
                    
                    dbDeleteRequest.onsuccess = () => { 
                        log("âœ“ IndexedDB ì‚­ì œ ì„±ê³µ"); 
                        setTimeout(resolve, 500);
                    };
                    
                    dbDeleteRequest.onerror = () => { 
                        log("IndexedDB ì‚­ì œ ì‹¤íŒ¨ (ë¬´ì‹œ)"); 
                        setTimeout(resolve, 500);
                    };
                    
                    dbDeleteRequest.onblocked = () => { 
                        log("IndexedDB ì‚­ì œ ì°¨ë‹¨ë¨ (ë¬´ì‹œ)"); 
                        setTimeout(resolve, 500);
                    };
                    
                    setTimeout(() => {
                        resolve();
                    }, 2000);
                    
                } catch(e) {
                    log("ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œ): " + e.message);
                    setTimeout(resolve, 500);
                }
            });
        }

        async function startApp() {
            if (isStarted) return;
            
            if (!webgazerLoaded) {
                log("WebGazerê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", true);
                return;
            }
            
            const startBtn = document.getElementById('start-btn');
            startBtn.textContent = "â³ ì´ˆê¸°í™” ì¤‘... (ìµœëŒ€ 30ì´ˆ)";
            startBtn.disabled = true;

            try {
                // ë°ì´í„° í´ë¦¬ì–´
                await clearLocalData();
                
                log("ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ ì¤‘...");
                const constraints = {
                    video: {
                        facingMode: 'user',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                log("âœ“ ì¹´ë©”ë¼ ê¶Œí•œ íšë“ ì„±ê³µ");
                stream.getTracks().forEach(track => track.stop());

                // WebGazer ì´ˆê¸°í™”
                await initWebGazer();
                
                // UI ì „í™˜
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('status').style.display = 'block';
                document.getElementById('reset-btn').style.display = 'block';
                
                const btns = document.querySelectorAll('.btn');
                btns.forEach(b => b.classList.add('active'));

                isStarted = true;
                log("âœ“ ì•± ì‹œì‘ ì™„ë£Œ");

            } catch (err) {
                log(`[ì´ˆê¸°í™” ì‹¤íŒ¨] ${err.name}: ${err.message}`, true);
                log(`[Stack] ${err.stack}`, true);
                
                startBtn.textContent = "ğŸ”„ ë‹¤ì‹œ ì‹œë„";
                startBtn.disabled = false;
                
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    alert("âŒ ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.\n\në¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•œ í›„\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
                } else if (err.name === 'NotFoundError') {
                    alert("âŒ ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\në‹¤ë¥¸ ì•±ì—ì„œ ì¹´ë©”ë¼ë¥¼ ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
                } else {
                    alert(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${err.message}\n\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜\në‹¤ë¥¸ ë¸Œë¼ìš°ì €(Chrome/Safari)ë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš”.`);
                }
            }
        }

        async function initWebGazer() {
            if (typeof webgazer === 'undefined') {
                throw new Error("WebGazer ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤");
            }

            log("WebGazer ì´ˆê¸°í™” ì‹œì‘...");
            log(`WebGazer ë²„ì „: ${webgazer.version || 'unknown'}`);

            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error("WebGazer ì´ˆê¸°í™” íƒ€ì„ì•„ì›ƒ (30ì´ˆ)"));
                }, 30000);

                try {
                    webgazer
                        .setRegression('ridge')
                        .setTracker('TFFacemesh')
                        .saveDataAcrossSessions(false)
                        .setGazeListener((data, clock) => {
                            try {
                                gazeListener(data, clock);
                            } catch (e) {
                                log(`gazeListener ì—ëŸ¬: ${e.message}`, true);
                            }
                        })
                        .begin()
                        .then(() => {
                            clearTimeout(timeout);
                            log("âœ“ WebGazer.begin() ì„±ê³µ");
                            
                            try {
                                webgazer
                                    .showVideoPreview(true)
                                    .showPredictionPoints(false)
                                    .applyKalmanFilter(true);
                                
                                log("âœ“ WebGazer ì˜µì…˜ ì„¤ì • ì™„ë£Œ");
                            } catch (e) {
                                log(`ì˜µì…˜ ì„¤ì • ì˜¤ë¥˜: ${e.message}`, true);
                            }
                            
                            setTimeout(() => {
                                const container = document.getElementById('webgazerVideoContainer');
                                if (container) {
                                    container.style.display = 'block';
                                    log("âœ“ ë¹„ë””ì˜¤ í”„ë¦¬ë·° í‘œì‹œ");
                                }
                                webgazerReady = true;
                                updateStatus("ë¹¨ê°„ ì ì„ ë³´ë©´ì„œ ì–‘ìª½ ë²„íŠ¼ì„ ë²ˆê°ˆì•„ ì—¬ëŸ¬ ë²ˆ ëˆŒëŸ¬ì£¼ì„¸ìš”");
                                resolve();
                            }, 2000);
                        })
                        .catch((err) => {
                            clearTimeout(timeout);
                            log(`WebGazer.begin() ì‹¤íŒ¨: ${err.message}`, true);
                            reject(err);
                        });
                        
                } catch (e) {
                    clearTimeout(timeout);
                    log(`WebGazer ì„¤ì • ì¤‘ ì˜¤ë¥˜: ${e.message}`, true);
                    reject(e);
                }
            });
        }

        function gazeListener(data, elapsedTime) {
            if (data == null || !webgazerReady) return;
            
            gazeDataCount++;
            if (gazeDataCount % 100 === 0) {
                log(`ì‹œì„  ë°ì´í„° ${gazeDataCount}ê°œ ìˆ˜ì‹ ë¨`);
            }
            
            smoothX = smoothX * SMOOTHING_FACTOR + data.x * (1 - SMOOTHING_FACTOR);
            smoothY = smoothY * SMOOTHING_FACTOR + data.y * (1 - SMOOTHING_FACTOR);
            
            const dot = document.getElementById('gaze-dot');
            if (dot) {
                dot.style.display = 'block';
                dot.style.left = smoothX + 'px';
                dot.style.top = smoothY + 'px';
            }

            if (!isSelecting && isStarted) {
                checkGaze(smoothX, smoothY);
            }
        }

        function checkGaze(x, y) {
            const yesBtn = document.getElementById('yes-btn').getBoundingClientRect();
            const noBtn = document.getElementById('no-btn').getBoundingClientRect();
            let target = null;

            const margin = 30;
            if (x >= yesBtn.left - margin && x <= yesBtn.right + margin && 
                y >= yesBtn.top - margin && y <= yesBtn.bottom + margin) {
                target = 'yes';
            } else if (x >= noBtn.left - margin && x <= noBtn.right + margin && 
                       y >= noBtn.top - margin && y <= noBtn.bottom + margin) {
                target = 'no';
            }

            if (target) {
                if (currentTarget !== target) {
                    currentTarget = target;
                    lookStart = Date.now();
                    updateProgress('yes', 0);
                    updateProgress('no', 0);
                } else {
                    const elapsed = Date.now() - lookStart;
                    const progress = Math.min((elapsed / DWELL_TIME) * 100, 100);
                    updateProgress(target, progress);
                    
                    if (elapsed >= DWELL_TIME) {
                        selectOption(target);
                    }
                }
            } else {
                if (currentTarget !== null) {
                    currentTarget = null;
                    lookStart = null;
                    updateProgress('yes', 0);
                    updateProgress('no', 0);
                }
            }
        }

        function updateProgress(target, percent) {
            const el = document.getElementById(`${target}-progress`);
            if (el) el.style.width = percent + '%';
        }

        function selectOption(choice) {
            isSelecting = true;
            updateProgress(choice, 100);
            
            const message = choice === 'yes' ? "ë„¤" : "ì•„ë‹ˆì˜¤";
            updateStatus(`âœ“ ì„ íƒë¨: ${message}`);
            log(`ì„ íƒ ì™„ë£Œ: ${message}`);
            
            calibrationCount++;
            
            if ('vibrate' in navigator) {
                navigator.vibrate(100);
            }
            
            if (window.speechSynthesis) {
                try {
                    const utterance = new SpeechSynthesisUtterance(message);
                    utterance.lang = 'ko-KR';
                    utterance.rate = 1.0;
                    utterance.pitch = 1.0;
                    window.speechSynthesis.speak(utterance);
                } catch (e) {
                    log(`ìŒì„± ì¶œë ¥ ì˜¤ë¥˜: ${e.message}`);
                }
            }

            setTimeout(() => {
                isSelecting = false;
                currentTarget = null;
                lookStart = null;
                updateProgress('yes', 0);
                updateProgress('no', 0);
                
                if (calibrationCount < 5) {
                    updateStatus(`ê³„ì† ì—°ìŠµí•´ì£¼ì„¸ìš” (${calibrationCount}/5+)`);
                } else {
                    updateStatus("ì‹œì„ ìœ¼ë¡œ ì„ íƒí•˜ì„¸ìš”");
                }
            }, 1500);
        }

        function handleClick(target) {
            if (!isStarted) return;
            
            log(`${target} ë²„íŠ¼ í´ë¦­ - ë³´ì • ë°ì´í„° ì¶”ê°€`);
            
            const btn = document.getElementById(target + '-btn');
            if (btn) {
                btn.style.transform = 'scale(0.95)';
                setTimeout(() => btn.style.transform = 'scale(1)', 150);
            }
            
            calibrationCount++;
            if (calibrationCount >= 3 && calibrationCount <= 10) {
                updateStatus(`ì¢‹ì•„ìš”! ${calibrationCount}ë²ˆ í´ë¦­ ì™„ë£Œ`);
            }
        }

        function updateStatus(text) {
            const statusEl = document.getElementById('status');
            if (statusEl) {
                statusEl.textContent = text;
            }
        }

        function resetApp() {
            if (confirm("ì•±ì„ ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                log("ì•± ì¬ì‹œì‘");
                if (window.webgazer) {
                    try {
                        webgazer.end();
                    } catch (e) {
                        log(`WebGazer ì¢…ë£Œ ì˜¤ë¥˜: ${e.message}`);
                    }
                }
                location.reload();
            }
        }

        window.addEventListener('beforeunload', () => {
            if (window.webgazer) {
                try {
                    webgazer.end();
                } catch (e) {
                    console.log('WebGazer cleanup error:', e);
                }
            }
        });
    </script>
</body>
</html>
